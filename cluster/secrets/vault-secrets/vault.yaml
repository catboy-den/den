apiVersion: v1
kind: Namespace
metadata:
  name: vault
---
apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: vault-repo
  namespace: vault
spec:
  interval: 24h
  url: https://helm.releases.hashicorp.com
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: vault
  namespace: vault
spec:
  interval: 30m
  chart:
    spec:
      chart: vault
      version: "0.x"
      sourceRef:
        kind: HelmRepository
        name: vault-repo
        namespace: vault
      interval: 12h
  values:
# metrics.serviceMonitor.enabled: true TODO, look into this
---
apiVersion: v1
kind: Secret
metadata:
  name: vault-auth
  namespace: vault
type: Opaque
stringData:
  token_reviewer_jwt: |
    {{ file "/var/run/secrets/kubernetes.io/serviceaccount/token" | b64enc }}
  kubernetes_host: https://kubernetes.default.svc.cluster.local
  kubernetes_ca_cert: |
    {{ file "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt" | b64enc }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: enable-vault-kubernetes-auth
  namespace: vault
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: enable-vault-kubernetes-auth
        image: vault
        imagePullPolicy: IfNotPresent
        command: ["vault"]
        args: ["write", "auth/kubernetes/config", "token_reviewer_jwt=@/vault/secrets/vault-auth/token_reviewer_jwt", "kubernetes_host=@/vault/secrets/vault-auth/kubernetes_host", "kubernetes_ca_cert=@/vault/secrets/vault-auth/kubernetes_ca_cert"]
        volumeMounts:
        - name: vault-auth
          mountPath: "/vault/secrets/vault-auth"
      volumes:
      - name: vault-auth
        secret:
          secretName: vault-auth
